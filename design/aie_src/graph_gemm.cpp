#include "graph_gemm.h"
#include "graph_utils.h"


template <template<int, int, int, int> class GEMM, 
  int M, int K, int N, int IS_RELU>
class GemmReluGraphTest : public adf::graph {

  private:
    GemmReluGraph<GEMM, M, K, N, IS_RELU> g;

  public:
    adf::input_plio plin[1];
    adf::output_plio plout[1];

    GemmReluGraphTest(
      const std::string& id,
      std::vector<float> weights,
      std::vector<float> bias,
      const std::string& INP_TXT,
      const std::string& OUT_TXT = "gemm_out.txt"
    ): g(weights, bias) { 
      plin[0] = adf::input_plio::create("plin0_gemm"+id+"_input", PLIO64_ARG(INP_TXT));
      plout[0] = adf::output_plio::create("plout0_gemm"+id+"_output", PLIO64_ARG(OUT_TXT));
      adf::connect<adf::window<M*K*4>> (plin[0].out[0], g.pin[0]);
      adf::connect<adf::window<M*N*4>> (g.pout[0], plout[0].in[0]);
    }

};


template <template<int, int, int, int> class GEMM, 
  int M, int K, int N, int IS_RELU>
class GemmReluStreamGraphTest : public adf::graph {

  private:
    GemmReluStreamGraph<GEMM, M, K, N, IS_RELU> g;

  public:
    adf::input_plio plin[1];
    adf::output_plio plout[1];

    adf::input_gmio gmio_w;

    GemmReluStreamGraphTest(
      const std::string& id,
      std::vector<float> bias,
      const std::string& INP_TXT,
      const std::string& OUT_TXT = "gemm_out.txt"
    ): g(bias) { 
      plin[0] = adf::input_plio::create("plin0_gemm"+id+"_input", PLIO64_ARG(INP_TXT));
      plout[0] = adf::output_plio::create("plout0_gemm"+id+"_output", PLIO64_ARG(OUT_TXT));
      gmio_w = adf::input_gmio::create("gmio0_gemm"+id+"_w", 64, 1000);
      
      adf::connect<adf::stream> (plin[0].out[0], g.pin[0]);
      adf::connect<adf::stream> (gmio_w.out[0], g.pin[1]);
      adf::connect<adf::window<M*N*4>> (g.pout[0], plout[0].in[0]);
    }

};


// instance to be compiled and used in host within xclbin
const int M = 7;
const int K = 36;
const int N = 10;
const int N_PAD4 = (N + 3)/4*4;
const int N_PAD8 = (N + 7)/8*8;

std::vector<float> fpweights_mknk {0.7653252482414246, 0.748663604259491, 0.9037197232246399, 0.08342243731021881, 0.5521924495697021, 0.5844760537147522, 0.961936354637146, 0.29214751720428467, 0.24082878232002258, 0.10029394179582596, 0.016429629176855087, 0.9295293092727661, 0.669916570186615, 0.7851529121398926, 0.28173011541366577, 0.5864101648330688, 0.06395526975393295, 0.48562759160995483, 0.9774951338768005, 0.8765052556991577, 0.3381589651107788, 0.961570143699646, 0.23170162737369537, 0.9493188261985779, 0.9413776993751526, 0.799202561378479, 0.6304479241371155, 0.8742879629135132, 0.2930202782154083, 0.8489435315132141, 0.6178767085075378, 0.013236857950687408, 0.34723350405693054, 0.14814086258411407, 0.9818294048309326, 0.4783703088760376, 0.49739137291908264, 0.6394725441932678, 0.36858460307121277, 0.13690027594566345, 0.8221177458763123, 0.1898479163646698, 0.5113189816474915, 0.2243170291185379, 0.09784448146820068, 0.8621914982795715, 0.9729194641113281, 0.9608346819877625, 0.9065554738044739, 0.774047315120697, 0.3331451416015625, 0.08110138773918152, 0.40724116563796997, 0.2322341352701187, 0.13248763978481293, 0.053427182137966156, 0.7255943417549133, 0.011427458375692368, 0.7705807685852051, 0.14694663882255554, 0.07952208071947098, 0.08960303664207458, 0.6720477938652039, 0.24536721408367157, 0.4205394685268402, 0.557368814945221, 0.8605511784553528, 0.7270442843437195, 0.2703278958797455, 0.131482794880867, 0.05537432059645653, 0.3015986382961273, 0.2621181607246399, 0.45614057779312134, 0.6832813620567322, 0.6956254243850708, 0.28351885080337524, 0.3799269497394562, 0.18115095794200897, 0.7885454893112183, 0.05684807524085045, 0.6969972252845764, 0.7786954045295715, 0.7774075865745544, 0.25942257046699524, 0.3738131523132324, 0.5875996351242065, 0.27282190322875977, 0.3708527982234955, 0.19705428183078766, 0.4598558843135834, 0.044612299650907516, 0.7997958660125732, 0.07695644348859787, 0.5188351273536682, 0.3068101108074188, 0.5775429606437683, 0.9594333171844482, 0.6455702185630798, 0.03536243736743927, 0.4304024279117584, 0.5100168585777283, 0.5361775159835815, 0.6813924908638, 0.2775960862636566, 0.12886056303977966, 0.3926756680011749, 0.9564056992530823, 0.1871308982372284, 0.9039839506149292, 0.5438059568405151, 0.4569114148616791, 0.8820413947105408, 0.45860394835472107, 0.7241676449775696, 0.3990253210067749, 0.9040443897247314, 0.6900250315666199, 0.6996220350265503, 0.32772040367126465, 0.7567786574363708, 0.6360610723495483, 0.2400202751159668, 0.16053882241249084, 0.796391487121582, 0.9591665863990784, 0.4581388235092163, 0.5909841656684875, 0.8577226400375366, 0.45722344517707825, 0.9518744945526123, 0.5757511854171753, 0.8207671046257019, 0.9088436961174011, 0.8155238032341003, 0.15941447019577026, 0.6288984417915344, 0.39843425154685974, 0.06271295249462128, 0.4240322411060333, 0.25868406891822815, 0.849038302898407, 0.03330462798476219, 0.9589827060699463, 0.35536885261535645, 0.3567068874835968, 0.01632850244641304, 0.18523232638835907, 0.40125951170921326, 0.9292914271354675, 0.0996149331331253, 0.9453015327453613, 0.869488537311554, 0.4541623890399933, 0.326700896024704, 0.23274412751197815, 0.6144647002220154, 0.03307459130883217, 0.015606064349412918, 0.428795725107193, 0.06807407736778259, 0.2519409954547882, 0.2211609184741974, 0.253191202878952, 0.13105523586273193, 0.012036222964525223, 0.11548429727554321, 0.6184802651405334, 0.9742562174797058, 0.9903450012207031, 0.40905410051345825, 0.1629544198513031, 0.6387617588043213, 0.4903053343296051, 0.9894098043441772, 0.06530420482158661, 0.7832344174385071, 0.28839850425720215, 0.24141861498355865, 0.6625045537948608, 0.24606318771839142, 0.6658591032028198, 0.5173085331916809, 0.4240889847278595, 0.5546877980232239, 0.2870515286922455, 0.7065746784210205, 0.414856880903244, 0.3605455458164215, 0.8286569118499756, 0.9249669313430786, 0.04600730910897255, 0.2326269894838333, 0.34851935505867004, 0.8149664998054504, 0.9854914546012878, 0.9689717292785645, 0.904948353767395, 0.2965562641620636, 0.9920112490653992, 0.24942004680633545, 0.10590615123510361, 0.9509525895118713, 0.2334202527999878, 0.6897682547569275, 0.05835635960102081, 0.7307090759277344, 0.8817201852798462, 0.27243688702583313, 0.3790569007396698, 0.3742961883544922, 0.7487882375717163, 0.2378072440624237, 0.17185309529304504, 0.4492916464805603, 0.30446839332580566, 0.8391891121864319, 0.23774182796478271, 0.5023894309997559, 0.9425836205482483, 0.6339976787567139, 0.8672894239425659, 0.940209686756134, 0.7507648468017578, 0.6995750665664673, 0.9679655432701111, 0.9944007992744446, 0.4518216848373413, 0.07086978107690811, 0.29279401898384094, 0.15235470235347748, 0.41748636960983276, 0.13128933310508728, 0.6041178107261658, 0.38280805945396423, 0.8953858613967896, 0.96779465675354, 0.5468848943710327, 0.2748235762119293, 0.5922304391860962, 0.8967611789703369, 0.40673333406448364, 0.5520782470703125, 0.2716527581214905, 0.4554441571235657, 0.4017135500907898, 0.24841345846652985, 0.5058664083480835, 0.31038081645965576, 0.37303486466407776, 0.5249704718589783, 0.7505950331687927, 0.3335074782371521, 0.9241587519645691, 0.8623185753822327, 0.048690296709537506, 0.2536425292491913, 0.4461355209350586, 0.10462789237499237, 0.34847599267959595, 0.7400975227355957, 0.6805144548416138, 0.6223844289779663, 0.7105283737182617, 0.20492368936538696, 0.3416981101036072, 0.676242470741272, 0.879234790802002, 0.5436780452728271, 0.2826996445655823, 0.030235258862376213, 0.7103368043899536, 0.007884103804826736, 0.37267908453941345, 0.5305371880531311, 0.922111451625824, 0.08949454873800278, 0.40594232082366943, 0.024313200265169144, 0.3426109850406647, 0.6222310662269592, 0.2790679335594177, 0.2097499519586563, 0.11570323258638382, 0.5771402716636658, 0.6952700018882751, 0.6719571352005005, 0.9488610029220581, 0.002703213831409812, 0.6471966505050659, 0.60039222240448, 0.5887396335601807, 0.9627703428268433, 0.016871673986315727, 0.6964824199676514, 0.8136786222457886, 0.5098071694374084, 0.33396488428115845, 0.7908401489257812, 0.09724292904138565, 0.44203564524650574, 0.5199523568153381, 0.6939564347267151, 0.09088572859764099, 0.2277594953775406, 0.4103015661239624, 0.6232946515083313, 0.8869608044624329, 0.618826150894165, 0.13346147537231445, 0.9805801510810852, 0.8717857599258423, 0.5027207732200623, 0.9223479628562927, 0.5413808226585388, 0.9233060479164124, 0.8298973441123962, 0.968286395072937, 0.919782817363739, 0.03603381663560867, 0.1747720092535019, 0.3891346752643585, 0.9521427154541016, 0.300028920173645, 0.16046763956546783, 0.8863046765327454, 0.4463944137096405, 0.9078755974769592, 0.16023047268390656, 0.6611174941062927, 0.4402637481689453, 0.07648676633834839, 0.6964631676673889, 0.2473987489938736, 0.03961552307009697, 0.05994429811835289, 0.06107853725552559, 0.9077329635620117, 0.7398838996887207, 0.8980623483657837, 0.6725823283195496, 0.5289399027824402, 0.30444636940956116, 0.997962236404419, 0.36218905448913574, 0.47064894437789917, 0.37824517488479614, 0.979526937007904, 0.1746583878993988, 0.32798799872398376, 0.6803486943244934, 0.06320761889219284, 0.60724937915802, 0.47764649987220764, 0.2839999794960022, 0.2384132742881775, 0.5145127177238464, 0.36792758107185364, 0.4565199017524719, 0.3374773859977722};
std::vector<float> fpweights_mkkn_pad {0.9704936742782593, 0.13343943655490875, 0.09680395573377609, 0.3433917164802551, 0.5910269021987915, 0.6591764688491821, 0.3972567617893219, 0.9992780089378357, 0.35189300775527954, 0.7214066386222839, 0.0, 0.0, 0.6375827193260193, 0.8130538463592529, 0.9762256741523743, 0.8897936344146729, 0.7645619511604309, 0.6982485055923462, 0.335498183965683, 0.14768557250499725, 0.06263600289821625, 0.2419017106294632, 0.0, 0.0, 0.432281494140625, 0.521996259689331, 0.7730835676193237, 0.9587409496307373, 0.1173204779624939, 0.10700414329767227, 0.5896947383880615, 0.7453980445861816, 0.848150372505188, 0.9358320832252502, 0.0, 0.0, 0.9834262132644653, 0.39980170130729675, 0.3803351819515228, 0.14780867099761963, 0.6849344372749329, 0.6567619442939758, 0.8620625734329224, 0.09725799411535263, 0.49777689576148987, 0.5810819268226624, 0.0, 0.0, 0.2415570467710495, 0.16902540624141693, 0.8595808148384094, 0.05853492394089699, 0.47062090039253235, 0.11583399772644043, 0.45705875754356384, 0.9799623489379883, 0.4237063527107239, 0.857124924659729, 0.0, 0.0, 0.11731556057929993, 0.2712520658969879, 0.40379273891448975, 0.39981213212013245, 0.6713835000991821, 0.3447181284427643, 0.713766872882843, 0.6391869187355042, 0.399161159992218, 0.43176013231277466, 0.0, 0.0, 0.614527702331543, 0.0700421929359436, 0.8224067091941833, 0.65342116355896, 0.7263424396514893, 0.5369229912757874, 0.11047711223363876, 0.4050356149673462, 0.40537357330322266, 0.3210429847240448, 0.0, 0.0, 0.029950324445962906, 0.73725426197052, 0.10978446155786514, 0.6063081622123718, 0.7032175064086914, 0.6347863078117371, 0.95914226770401, 0.10329815745353699, 0.8671671748161316, 0.02919023483991623, 0.0, 0.0, 0.534916877746582, 0.4042436182498932, 0.5241838693618774, 0.36509987711906433, 0.19056691229343414, 0.01912289671599865, 0.5181497931480408, 0.8427768349647522, 0.3732159435749054, 0.2228638231754303, 0.0, 0.0, 0.080532006919384, 0.0853109210729599, 0.22139644622802734, 0.10001406073570251, 0.26503971219062805, 0.06614946573972702, 0.06560486555099487, 0.8562761545181274, 0.1621202677488327, 0.5596824288368225, 0.0, 0.0, 0.7734555602073669, 0.4564095735549927, 0.15336887538433075, 0.19959613680839539, 0.43298420310020447, 0.52823406457901, 0.3494403064250946, 0.7814795970916748, 0.7510216236114502, 0.9272118210792542, 0.0, 0.0, 0.028952548280358315, 0.8956912755966187, 0.39256879687309265, 0.8783724904060364, 0.690784752368927, 0.987348735332489, 0.7592824697494507, 0.3645446300506592, 0.5010631680488586, 0.37638914585113525, 0.0, 0.0, 0.364911824464798, 0.2609044909477234, 0.49597030878067017, 0.6817399263381958, 0.27734026312828064, 0.5243797898292542, 0.117380291223526, 0.1598452925682068, 0.04680635407567024, 0.9707314372062683, 0.0, 0.0, 0.0038603513967245817, 0.17857997119426727, 0.6128667593002319, 0.08136960119009018, 0.8818964958190918, 0.7196201682090759, 0.9663899540901184, 0.5076355338096619, 0.3004036843776703, 0.549500584602356, 0.0, 0.0, 0.9308187365531921, 0.5207614302635193, 0.2672070264816284, 0.8773987889289856, 0.3719187378883362, 0.0013833499979227781, 0.2476850152015686, 0.31823351979255676, 0.8587774634361267, 0.4585031569004059, 0.0, 0.0, 0.4445872902870178, 0.33610227704048157, 0.880678117275238, 0.9450267553329468, 0.9918903112411499, 0.3767412602901459, 0.9661474227905273, 0.7918795943260193, 0.675689160823822, 0.24488948285579681, 0.0, 0.0, 0.21645726263523102, 0.1660478264093399, 0.9227566123008728, 0.2940766513347626, 0.4530942440032959, 0.49395784735679626, 0.7781715989112854, 0.8442349433898926, 0.1390727013349533, 0.4269043505191803, 0.0, 0.0, 0.842854917049408, 0.8180332779884338, 0.10241375863552094, 0.15638335049152374, 0.304198682308197, 0.07535906881093979, 0.4246630072593689, 0.10761770606040955, 0.5682175755500793, 0.24655693769454956, 0.0, 0.0, 0.5964330434799194, 0.11752564460039139, 0.9758838415145874, 0.9325612187385559, 0.39179694652557373, 0.24217858910560608, 0.2503982186317444, 0.4833935499191284, 0.0399928018450737, 0.6397051215171814, 0.0, 0.0, 0.408302903175354, 0.3774065673351288, 0.8093649744987488, 0.7090354561805725, 0.9543338418006897, 0.3519362509250641, 0.8975427746772766, 0.7699671983718872, 0.35742464661598206, 0.6216654181480408, 0.0, 0.0, 0.28856995701789856, 0.8743999004364014, 0.11242731660604477, 0.21243436634540558, 0.183033287525177, 0.4030260145664215, 0.7452329397201538, 0.5269074440002441, 0.48767632246017456, 0.0005459649255499244, 0.0, 0.0, 0.4254017174243927, 0.06355377286672592, 0.20825324952602386, 0.9323939681053162, 0.21539820730686188, 0.8583376407623291, 0.8028934001922607, 0.1591462343931198, 0.6057119369506836, 0.1156618744134903, 0.0, 0.0, 0.7278881669044495, 0.6374622583389282, 0.8119385838508606, 0.47938454151153564, 0.914863109588623, 0.049348946660757065, 0.2928885519504547, 0.715052604675293, 0.4181092083454132, 0.1729513555765152, 0.0, 0.0, 0.10721074789762497, 0.8173391222953796, 0.47314298152923584, 0.8822836875915527, 0.7332891225814819, 0.40972620248794556, 0.37351101636886597, 0.5156383514404297, 0.8890599608421326, 0.7372785806655884, 0.0, 0.0, 0.005152964498847723, 0.6941578388214111, 0.9195073843002319, 0.7104557752609253, 0.17700578272342682, 0.483518123626709, 0.14031602442264557, 0.3589952886104584, 0.9371170401573181, 0.923305332660675, 0.0, 0.0, 0.2828368544578552, 0.339631050825119, 0.6002128720283508, 0.9631972908973694, 0.14780133962631226, 0.2569166421890259, 0.8735568523406982, 0.4918922185897827, 0.898961067199707, 0.18551789224147797, 0.0, 0.0, 0.5326685905456543, 0.32626962661743164, 0.3165425658226013, 0.44687697291374207, 0.43307745456695557, 0.35734689235687256, 0.9149707555770874, 0.7317441701889038, 0.7275469899177551, 0.28991344571113586, 0.0, 0.0, 0.577709436416626, 0.7791794538497925, 0.795590341091156, 0.34453046321868896, 0.7708727717399597, 0.7358939051628113, 0.14150647819042206, 0.8659454584121704, 0.441321462392807, 0.4864104390144348, 0.0, 0.0, 0.44836917519569397, 0.5678460001945496, 0.6211692690849304, 0.49817955493927, 0.8667885661125183, 0.6277347803115845, 0.4014279544353485, 0.41669175028800964, 0.8108386397361755, 0.3481919467449188, 0.0, 0.0, 0.21145479381084442, 0.05938318744301796, 0.8760268688201904, 0.9185464382171631, 0.12012018263339996, 0.33447372913360596, 0.17537206411361694, 0.11589846760034561, 0.8998667597770691, 0.0568772591650486, 0.0, 0.0, 0.9804856777191162, 0.09645085781812668, 0.8634706735610962, 0.5665060877799988, 0.3679174780845642, 0.3423423767089844, 0.7573641538619995, 0.3145732879638672, 0.6573188900947571, 0.5173260569572449, 0.0, 0.0, 0.48496565222740173, 0.9011621475219727, 0.5546450614929199, 0.8268616199493408, 0.7255735397338867, 0.03855724632740021, 0.773110032081604, 0.2168702483177185, 0.9031496644020081, 0.0429241918027401, 0.0, 0.0, 0.3330720365047455, 0.09973295032978058, 0.4755891263484955, 0.820022463798523, 0.29818734526634216, 0.15093488991260529, 0.3302670419216156, 0.8138801455497742, 0.14038395881652832, 0.22736245393753052, 0.0, 0.0, 0.06885196268558502, 0.7057100534439087, 0.39523324370384216, 0.310839980840683, 0.7186263799667358, 0.33597755432128906, 0.7277712821960449, 0.8151993751525879, 0.21766284108161926, 0.9738187193870544, 0.0, 0.0, 0.16235794126987457, 0.29084089398384094, 0.1797952950000763, 0.34550565481185913, 0.480060875415802, 0.5221758484840393, 0.8536060452461243, 0.8894479274749756, 0.22010385990142822, 0.6228940486907959, 0.0, 0.0, 0.11149605363607407, 0.4589698612689972, 0.32233354449272156, 0.3165007531642914, 0.48258423805236816, 0.7298276424407959, 0.06918265670537949, 0.8791733384132385, 0.7348137497901917, 0.1764993816614151, 0.0, 0.0};
std::vector<float> fpweights_mkkn_pad_shuffled {0.9704936742782593, 0.13343943655490875, 0.09680395573377609, 0.3433917164802551, 0.5910269021987915, 0.6591764688491821, 0.3972567617893219, 0.9992780089378357, 0.6375827193260193, 0.8130538463592529, 0.9762256741523743, 0.8897936344146729, 0.7645619511604309, 0.6982485055923462, 0.335498183965683, 0.14768557250499725, 0.432281494140625, 0.521996259689331, 0.7730835676193237, 0.9587409496307373, 0.1173204779624939, 0.10700414329767227, 0.5896947383880615, 0.7453980445861816, 0.9834262132644653, 0.39980170130729675, 0.3803351819515228, 0.14780867099761963, 0.6849344372749329, 0.6567619442939758, 0.8620625734329224, 0.09725799411535263, 0.2415570467710495, 0.16902540624141693, 0.8595808148384094, 0.05853492394089699, 0.47062090039253235, 0.11583399772644043, 0.45705875754356384, 0.9799623489379883, 0.11731556057929993, 0.2712520658969879, 0.40379273891448975, 0.39981213212013245, 0.6713835000991821, 0.3447181284427643, 0.713766872882843, 0.6391869187355042, 0.614527702331543, 0.0700421929359436, 0.8224067091941833, 0.65342116355896, 0.7263424396514893, 0.5369229912757874, 0.11047711223363876, 0.4050356149673462, 0.029950324445962906, 0.73725426197052, 0.10978446155786514, 0.6063081622123718, 0.7032175064086914, 0.6347863078117371, 0.95914226770401, 0.10329815745353699, 0.534916877746582, 0.4042436182498932, 0.5241838693618774, 0.36509987711906433, 0.19056691229343414, 0.01912289671599865, 0.5181497931480408, 0.8427768349647522, 0.080532006919384, 0.0853109210729599, 0.22139644622802734, 0.10001406073570251, 0.26503971219062805, 0.06614946573972702, 0.06560486555099487, 0.8562761545181274, 0.7734555602073669, 0.4564095735549927, 0.15336887538433075, 0.19959613680839539, 0.43298420310020447, 0.52823406457901, 0.3494403064250946, 0.7814795970916748, 0.028952548280358315, 0.8956912755966187, 0.39256879687309265, 0.8783724904060364, 0.690784752368927, 0.987348735332489, 0.7592824697494507, 0.3645446300506592, 0.364911824464798, 0.2609044909477234, 0.49597030878067017, 0.6817399263381958, 0.27734026312828064, 0.5243797898292542, 0.117380291223526, 0.1598452925682068, 0.0038603513967245817, 0.17857997119426727, 0.6128667593002319, 0.08136960119009018, 0.8818964958190918, 0.7196201682090759, 0.9663899540901184, 0.5076355338096619, 0.9308187365531921, 0.5207614302635193, 0.2672070264816284, 0.8773987889289856, 0.3719187378883362, 0.0013833499979227781, 0.2476850152015686, 0.31823351979255676, 0.4445872902870178, 0.33610227704048157, 0.880678117275238, 0.9450267553329468, 0.9918903112411499, 0.3767412602901459, 0.9661474227905273, 0.7918795943260193, 0.21645726263523102, 0.1660478264093399, 0.9227566123008728, 0.2940766513347626, 0.4530942440032959, 0.49395784735679626, 0.7781715989112854, 0.8442349433898926, 0.842854917049408, 0.8180332779884338, 0.10241375863552094, 0.15638335049152374, 0.304198682308197, 0.07535906881093979, 0.4246630072593689, 0.10761770606040955, 0.5964330434799194, 0.11752564460039139, 0.9758838415145874, 0.9325612187385559, 0.39179694652557373, 0.24217858910560608, 0.2503982186317444, 0.4833935499191284, 0.408302903175354, 0.3774065673351288, 0.8093649744987488, 0.7090354561805725, 0.9543338418006897, 0.3519362509250641, 0.8975427746772766, 0.7699671983718872, 0.28856995701789856, 0.8743999004364014, 0.11242731660604477, 0.21243436634540558, 0.183033287525177, 0.4030260145664215, 0.7452329397201538, 0.5269074440002441, 0.4254017174243927, 0.06355377286672592, 0.20825324952602386, 0.9323939681053162, 0.21539820730686188, 0.8583376407623291, 0.8028934001922607, 0.1591462343931198, 0.7278881669044495, 0.6374622583389282, 0.8119385838508606, 0.47938454151153564, 0.914863109588623, 0.049348946660757065, 0.2928885519504547, 0.715052604675293, 0.10721074789762497, 0.8173391222953796, 0.47314298152923584, 0.8822836875915527, 0.7332891225814819, 0.40972620248794556, 0.37351101636886597, 0.5156383514404297, 0.005152964498847723, 0.6941578388214111, 0.9195073843002319, 0.7104557752609253, 0.17700578272342682, 0.483518123626709, 0.14031602442264557, 0.3589952886104584, 0.2828368544578552, 0.339631050825119, 0.6002128720283508, 0.9631972908973694, 0.14780133962631226, 0.2569166421890259, 0.8735568523406982, 0.4918922185897827, 0.5326685905456543, 0.32626962661743164, 0.3165425658226013, 0.44687697291374207, 0.43307745456695557, 0.35734689235687256, 0.9149707555770874, 0.7317441701889038, 0.577709436416626, 0.7791794538497925, 0.795590341091156, 0.34453046321868896, 0.7708727717399597, 0.7358939051628113, 0.14150647819042206, 0.8659454584121704, 0.44836917519569397, 0.5678460001945496, 0.6211692690849304, 0.49817955493927, 0.8667885661125183, 0.6277347803115845, 0.4014279544353485, 0.41669175028800964, 0.21145479381084442, 0.05938318744301796, 0.8760268688201904, 0.9185464382171631, 0.12012018263339996, 0.33447372913360596, 0.17537206411361694, 0.11589846760034561, 0.9804856777191162, 0.09645085781812668, 0.8634706735610962, 0.5665060877799988, 0.3679174780845642, 0.3423423767089844, 0.7573641538619995, 0.3145732879638672, 0.48496565222740173, 0.9011621475219727, 0.5546450614929199, 0.8268616199493408, 0.7255735397338867, 0.03855724632740021, 0.773110032081604, 0.2168702483177185, 0.3330720365047455, 0.09973295032978058, 0.4755891263484955, 0.820022463798523, 0.29818734526634216, 0.15093488991260529, 0.3302670419216156, 0.8138801455497742, 0.06885196268558502, 0.7057100534439087, 0.39523324370384216, 0.310839980840683, 0.7186263799667358, 0.33597755432128906, 0.7277712821960449, 0.8151993751525879, 0.16235794126987457, 0.29084089398384094, 0.1797952950000763, 0.34550565481185913, 0.480060875415802, 0.5221758484840393, 0.8536060452461243, 0.8894479274749756, 0.11149605363607407, 0.4589698612689972, 0.32233354449272156, 0.3165007531642914, 0.48258423805236816, 0.7298276424407959, 0.06918265670537949, 0.8791733384132385, 0.35189300775527954, 0.7214066386222839, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.06263600289821625, 0.2419017106294632, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.848150372505188, 0.9358320832252502, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.49777689576148987, 0.5810819268226624, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.4237063527107239, 0.857124924659729, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.399161159992218, 0.43176013231277466, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.40537357330322266, 0.3210429847240448, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8671671748161316, 0.02919023483991623, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.3732159435749054, 0.2228638231754303, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1621202677488327, 0.5596824288368225, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7510216236114502, 0.9272118210792542, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5010631680488586, 0.37638914585113525, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.04680635407567024, 0.9707314372062683, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.3004036843776703, 0.549500584602356, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8587774634361267, 0.4585031569004059, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.675689160823822, 0.24488948285579681, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1390727013349533, 0.4269043505191803, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5682175755500793, 0.24655693769454956, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0399928018450737, 0.6397051215171814, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.35742464661598206, 0.6216654181480408, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.48767632246017456, 0.0005459649255499244, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.6057119369506836, 0.1156618744134903, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.4181092083454132, 0.1729513555765152, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8890599608421326, 0.7372785806655884, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9371170401573181, 0.923305332660675, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.898961067199707, 0.18551789224147797, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7275469899177551, 0.28991344571113586, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.441321462392807, 0.4864104390144348, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8108386397361755, 0.3481919467449188, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.8998667597770691, 0.0568772591650486, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.6573188900947571, 0.5173260569572449, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9031496644020081, 0.0429241918027401, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.14038395881652832, 0.22736245393753052, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.21766284108161926, 0.9738187193870544, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.22010385990142822, 0.6228940486907959, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.7348137497901917, 0.1764993816614151, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0};
std::vector<float> fpbias {0.9391608834266663, 0.5063122510910034, 0.9998085498809814, 0.19725947082042694, 0.5349081754684448, 0.2902480363845825, 0.3041735589504242, 0.5910654067993164, 0.9217190742492676, 0.805263876914978};

// MK * NK
GemmReluGraphTest<GemmReluScalarMKNK, M, K, N, 1> gemmReluScalarMKNK(
  "gemmReluScalarMKNK", fpweights_mknk, fpbias, 
  "gemm_fpin.txt", "gemmMKNK_fpout_shape7x10_GemmReluScalarMKNK.txt");

GemmReluStreamGraphTest<GemmReluScalarMKNKStream, M, K, N, 1> gemmReluScalarMKNKStream(
  "gemmReluScalarMKNKStream", fpbias,
  "gemm_fpin.txt", "gemmMKNK_fpout_shape7x10_GemmReluScalarMKNKStream.txt");

// MK * KN
GemmReluGraphTest<GemmReluScalarMKKN, M, K, N_PAD4, 1> gemmReluScalarMKKN(
  "gemmReluScalarMKKN", fpweights_mkkn_pad, fpbias, 
  "gemm_fpin.txt", "gemmMKKN_fpout_shape7x10_GemmReluScalarMKKN.txt");

GemmReluGraphTest<GemmReluMKKN, M, K, N_PAD4, 1> gemmReluMKKN(
  "gemmReluMKKN", fpweights_mkkn_pad, fpbias, 
  "gemm_fpin.txt", "gemmMKKN_fpout_shape7x10_GemmReluMKKN.txt");

GemmReluStreamGraphTest<GemmReluMKKNStream, M, K, N_PAD8, 1> gemmReluMKKNStream(
  "gemmReluMKKNStream", fpbias,
  "gemm_fpin.txt", "gemmMKKN_fpout_shape7x10_GemmReluMKKNStream.txt");


#if defined(__X86SIM__) || defined(__AIESIM__)
int main(int argc, char ** argv) {
  // init gmio
  float_t* mknk_buf = (float_t *) adf::GMIO::malloc(M*K*N*sizeof(float_t));
  float_t* mkkn_shuffled_buf = (float_t *) adf::GMIO::malloc(M*K*N_PAD8*sizeof(float_t));
  for (int i = 0; i < M; i++) {
    memcpy(mknk_buf + i*K*N, fpweights_mknk.data(), K*N*sizeof(float_t));
    memcpy(mkkn_shuffled_buf + i*K*N_PAD8, fpweights_mkkn_pad_shuffled.data(), K*N_PAD8*sizeof(float_t));
  }

  // MK * NK
  adfCheck(gemmReluScalarMKNK.init(), "init gemmReluScalarMKNK");
  adfCheck(gemmReluScalarMKNK.run(ITER_CNT), "run gemmReluScalarMKNK");
	adfCheck(gemmReluScalarMKNK.end(), "end gemmReluScalarMKNK");

  adfCheck(gemmReluScalarMKNKStream.init(), "init gemmReluScalarMKNKStream");
  gemmReluScalarMKNKStream.gmio_w.gm2aie_nb(mknk_buf, M*K*N*sizeof(float_t));
  adfCheck(gemmReluScalarMKNKStream.run(ITER_CNT), "run gemmReluScalarMKNKStream");
	adfCheck(gemmReluScalarMKNKStream.end(), "end gemmReluScalarMKNKStream");

  // MK * KN
  adfCheck(gemmReluScalarMKKN.init(), "init gemmReluScalarMKKN");
  adfCheck(gemmReluScalarMKKN.run(ITER_CNT), "run gemmReluScalarMKKN");
	adfCheck(gemmReluScalarMKKN.end(), "end gemmReluScalarMKKN");

  adfCheck(gemmReluMKKN.init(), "init gemmReluMKKN");
  adfCheck(gemmReluMKKN.run(ITER_CNT), "run gemmReluMKKN");
	adfCheck(gemmReluMKKN.end(), "end gemmReluMKKN");

  adfCheck(gemmReluMKKNStream.init(), "init gemmReluMKKNStream");
  gemmReluMKKNStream.gmio_w.gm2aie_nb(mkkn_shuffled_buf, M*K*N_PAD8*sizeof(float_t));
  adfCheck(gemmReluMKKNStream.run(ITER_CNT), "run gemmReluMKKNStream");
	adfCheck(gemmReluMKKNStream.end(), "end gemmReluMKKNStream");
  
  // cleanup gmio
  adf::GMIO::free(mknk_buf);
  adf::GMIO::free(mkkn_shuffled_buf);
  return 0;
}
#endif
